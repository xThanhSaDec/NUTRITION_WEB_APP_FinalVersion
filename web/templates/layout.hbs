<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NutriDish</title>
  <!-- Favicon: prefer SVG fallback already in assets -->
  <link rel="icon" type="image/svg+xml" href="/app/assets/logo-fallback.svg">
  <link rel="shortcut icon" href="/app/assets/logo-fallback.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">

  <link
                  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
                  rel="stylesheet"
                  integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
                  crossorigin="anonymous"
              />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{{styles_href}}" />
  <script src="{{handlebars_js}}"></script>
  <script src="{{supabase_js}}"></script>
  <script src="{{chart_js}}"></script>
  <script src="{{config_js}}"></script>
  <script>
    // Global Supabase init + clean OAuth hash after login
    (function(){
      try{
        const cfg = window.APP_CONFIG || {};
        if (window.supabase && cfg.SUPABASE_URL && cfg.SUPABASE_ANON_KEY){
          window.SUPABASE = window.SUPABASE || window.supabase.createClient(
            cfg.SUPABASE_URL,
            cfg.SUPABASE_ANON_KEY,
            { auth: { storageKey: 'nutri-auth' } }
          );
          const sb = window.SUPABASE;
          const hash = window.location.hash || '';
          if (hash.includes('access_token=')){
            const params = new URLSearchParams(hash.substring(1));
            const access_token = params.get('access_token');
            const refresh_token = params.get('refresh_token');
            const expires_in = parseInt(params.get('expires_in')||'3600',10);
            if (access_token){
              sb.auth.setSession({ access_token, refresh_token, expires_in })
                .finally(()=>{
                  try{ history.replaceState({}, document.title, window.location.pathname); }catch(_e){}
                  if (location.pathname === '/login') { location.replace('/profile'); }
                });
            }
          }
          sb.auth.onAuthStateChange((event, _session)=>{
            if (event === 'SIGNED_IN' && (window.location.hash||'').includes('access_token')){
              try{ history.replaceState({}, document.title, window.location.pathname); }catch(_e){}
            }
          });
        }
      }catch(e){ console.warn('supabase init/hash handler failed', e); }
    })();
  </script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  {{> header}}
  <main class="container">
    {{{body}}}
  </main>
  {{> footer}}
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
</body>
</html>
